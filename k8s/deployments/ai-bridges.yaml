
apiVersion: apps/v1
kind: Deployment
metadata:
  name: context7-bridge
  namespace: mcp-gateway
spec:
  replicas: 1
  selector:
    matchLabels: { app: context7-bridge }
  template:
    metadata:
      labels:
        app: context7-bridge
        app.kubernetes.io/name: mcp-gateway
        app.kubernetes.io/component: context7-bridge
    spec:
      containers:
      - name: context7-bridge
        image: supercorp/supergateway:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9030
          name: http
        env:
        - name: CONTEXT7_API_KEY
          valueFrom:
            secretKeyRef:
              name: mcp-gateway-secrets
              key: CONTEXT7_API_KEY
        - name: http_proxy
          valueFrom: { configMapKeyRef: { name: mcp-gateway-config, key: PROXY_SERVER, optional: true } }
        - name: https_proxy
          valueFrom: { configMapKeyRef: { name: mcp-gateway-config, key: PROXY_SERVER, optional: true } }
        - name: HTTP_PROXY
          valueFrom: { configMapKeyRef: { name: mcp-gateway-config, key: PROXY_SERVER, optional: true } }
        - name: HTTPS_PROXY
          valueFrom: { configMapKeyRef: { name: mcp-gateway-config, key: PROXY_SERVER, optional: true } }
        - name: no_proxy
          valueFrom: { configMapKeyRef: { name: mcp-gateway-config, key: PROXY_BYPASS, optional: true } }
        - name: NO_PROXY
          valueFrom: { configMapKeyRef: { name: mcp-gateway-config, key: PROXY_BYPASS, optional: true } }
        resources:
          requests: { memory: "256Mi", cpu: "200m" }
          limits:   { memory: "512Mi", cpu: "500m" }

        # โปรบ: รอช่วง npx ดึงแพ็กเกจ
        startupProbe:
          tcpSocket: { port: 9030 }
          failureThreshold: 30
          periodSeconds: 10

        livenessProbe:
          tcpSocket: { port: 9030 }
          initialDelaySeconds: 10
          periodSeconds: 20
          timeoutSeconds: 3
          failureThreshold: 3

        readinessProbe:
          tcpSocket: { port: 9030 }
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 2
          failureThreshold: 3

        command:
        - supergateway
        - --port
        - "9030"
        - --ssePath
        - /sse
        - --messagePath
        - /message
        - --outputTransport
        - sse
        - --stdio
        - >
          CONTEXT7_API_KEY=$(CONTEXT7_API_KEY) npx -y @upstash/context7-mcp@latest

      restartPolicy: Always
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gistpad-bridge
  namespace: mcp-gateway
spec:
  replicas: 1
  selector:
    matchLabels: { app: gistpad-bridge }
  template:
    metadata:
      labels:
        app: gistpad-bridge
        app.kubernetes.io/name: mcp-gateway
        app.kubernetes.io/component: gistpad-bridge
    spec:
      containers:
      - name: gistpad-bridge
        image: supercorp/supergateway:latest
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9010
          name: http
        env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: mcp-gateway-secrets
              key: GITHUB_TOKEN
        - name: http_proxy
          valueFrom: { configMapKeyRef: { name: mcp-gateway-config, key: PROXY_SERVER, optional: true } }
        - name: https_proxy
          valueFrom: { configMapKeyRef: { name: mcp-gateway-config, key: PROXY_SERVER, optional: true } }
        - name: HTTP_PROXY
          valueFrom: { configMapKeyRef: { name: mcp-gateway-config, key: PROXY_SERVER, optional: true } }
        - name: HTTPS_PROXY
          valueFrom: { configMapKeyRef: { name: mcp-gateway-config, key: PROXY_SERVER, optional: true } }
        - name: no_proxy
          valueFrom: { configMapKeyRef: { name: mcp-gateway-config, key: PROXY_BYPASS, optional: true } }
        - name: NO_PROXY
          valueFrom: { configMapKeyRef: { name: mcp-gateway-config, key: PROXY_BYPASS, optional: true } }
        resources:
          requests: { memory: "256Mi", cpu: "200m" }
          limits:   { memory: "512Mi", cpu: "500m" }

        startupProbe:
          tcpSocket: { port: 9010 }
          failureThreshold: 30
          periodSeconds: 10

        livenessProbe:
          tcpSocket: { port: 9010 }
          initialDelaySeconds: 10
          periodSeconds: 20
          timeoutSeconds: 3
          failureThreshold: 3

        readinessProbe:
          tcpSocket: { port: 9010 }
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 2
          failureThreshold: 3

        command:
        - supergateway
        - --port
        - "9010"
        - --ssePath
        - /sse
        - --messagePath
        - /message
        - --outputTransport
        - sse
        - --stdio
        - >
          GITHUB_TOKEN=$(GITHUB_TOKEN) npx -y gistpad-mcp --daily --starred --archived

      restartPolicy: Always
